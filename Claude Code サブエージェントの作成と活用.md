# Claude Code サブエージェントの作成と活用

このドキュメントは、Claude Codeの「サブエージェント」機能について、その概要、作成方法、設定オプション、実践的な活用パターンを日本語で解説するものです。

**出典:** [Create custom subagents - Claude Code Docs](https://code.claude.com/docs/en/sub-agents) [1]

---

## 1. サブエージェントとは？

サブエージェントは、特定の種類のタスクを処理するために特化されたAIアシスタントです。各サブエージェントは、独自のコンテキストウィンドウ、カスタムシステムプロンプト、特定のツールアクセス権、独立したパーミッションを持って動作します。Claudeがサブエージェントの専門分野に一致するタスクに遭遇すると、そのタスクをサブエージェントに委任します。サブエージェントは独立して作業を行い、結果を返します。

### サブエージェントの利点

- **コンテキストの保持:** 探索や実装といった詳細な作業をメインの対話から分離することで、メインのコンテキストをクリーンに保ちます。
- **制約の強制:** サブエージェントが使用できるツールを制限することで、安全性を高め、意図しない操作を防ぎます。
- **設定の再利用:** ユーザーレベルでサブエージェントを作成すれば、複数のプロジェクトで同じ設定を再利用できます。
- **振る舞いの特化:** 特定のドメインに焦点を当てたシステムプロンプトにより、専門的なタスクの精度を高めます。
- **コスト管理:** より高速で安価なモデル（例: Haiku）にタスクをルーティングすることで、コストを最適化します。

Claude Codeには、`Explore`（探索）、`Plan`（計画）、`general-purpose`（汎用）といった組み込みのサブエージェントが含まれていますが、特定のタスクに合わせてカスタムサブエージェントを作成することも可能です。

## 2. サブエージェントの作成（クイックスタート）

サブエージェントは、YAMLフロントマターを持つMarkdownファイルとして定義されます。`/agents`コマンドを使用すると、対話的に作成できます。

**作成手順:**
1.  Claude Codeで`/agents`コマンドを実行します。
2.  「Create new agent」を選択し、スコープ（例: User-level）を選びます。
3.  「Generate with Claude」を選択し、サブエージェントの役割を自然言語で記述します。（例: 「可読性、パフォーマンス、ベストプラクティスの観点からファイルをスキャンし、改善案を提案するコード改善エージェント」）
4.  サブエージェントが使用できるツールを選択します。読み取り専用のエージェントであれば、「Read-only tools」のみを選択します。
5.  使用するモデル（Opus, Sonnet, Haiku）を選択します。
6.  UIで識別しやすくするための背景色を選びます。
7.  保存すれば、すぐに利用可能になります。

## 3. サブエージェントの設定

### スコープの選択

サブエージェントは、保存場所によってスコープが決まります。同じ名前のサブエージェントが複数存在する場合、優先度の高い場所の設定が適用されます。

| 保存場所 | スコープ | 優先度 | 作成方法 |
|---|---|---|---|
| `--agents` CLIフラグ | 現在のセッション | 1 (最高) | 起動時にJSONで渡す |
| `.claude/agents/` | 現在のプロジェクト | 2 | 対話的または手動 |
| `~/.claude/agents/` | 全プロジェクト | 3 | 対話的または手動 |
| プラグインの`agents/`ディレクトリ | プラグインが有効な場所 | 4 (最低) | プラグインと共にインストール |

### ファイルの記述

サブエージェントは、設定を記述するYAMLフロントマターと、システムプロンプトとなるMarkdownの本文で構成されます。

```yaml
---
name: code-reviewer
description: Reviews code for quality and best practices
tools: Read, Glob, Grep
model: sonnet
---

You are a code reviewer. When invoked, analyze the code and provide
specific, actionable feedback on quality, security, and best practices.
```

**主要なフロントマターフィールド:**
- `name` (必須): サブエージェントのユニークな識別子。
- `description` (必須): Claudeがいつこのサブエージェントに委任すべきかを判断するための説明。
- `tools`: サブエージェントが使用できるツールのリスト。
- `disallowedTools`: 使用を禁止するツールのリスト。
- `model`: 使用するモデル (`opus`, `sonnet`, `haiku`, `inherit`)。
- `permissionMode`: パーミッションプロンプトの処理方法 (`default`, `acceptEdits`, `dontAsk`, `bypassPermissions`, `plan`)。
- `skills`: 起動時にコンテキストに読み込むスキルのリスト。

## 4. サブエージェントとの連携

### 自動的な委任

Claudeは、ユーザーのタスク要求、サブエージェントの`description`、現在のコンテキストに基づいて、タスクを自動的に委任します。`description`に「積極的に使用する」といったフレーズを含めると、より能動的な委任を促せます。また、「code-reviewerサブエージェントを使って最近の変更をレビューして」のように、明示的にサブエージェントを指定することも可能です。

### フォアグラウンド実行とバックグラウンド実行

- **フォアグラウンド:** メインの対話をブロックし、完了するまで実行されます。許可プロンプトや質問はユーザーに直接渡されます。
- **バックグラウンド:** メインの対話と並行して実行されます。事前に承認されていない操作は自動的に拒否されます。

タスクの性質に応じてClaudeが実行モードを判断しますが、「バックグラウンドで実行して」と指示したり、`Ctrl+B`で実行中のタスクをバックグラウンドに送ったりすることもできます。

## 5. 一般的な活用パターン

- **大量の出力を伴う操作の分離:** テストの実行やログファイルの処理など、大量の出力を生成するタスクをサブエージェントに任せることで、メインのコンテキストを簡潔に保ちます。
- **並列リサーチ:** 互いに独立した調査タスクを複数のサブエージェントに同時に実行させ、後でClaudeに結果を統合させます。
- **サブエージェントの連鎖:** 複数ステップのワークフローにおいて、「コードレビューサブエージェントでパフォーマンスの問題を見つけ、次にオプティマイザサブエージェントでそれを修正する」のように、サブエージェントを順番に使用します。

## 6. サブエージェントのコンテキスト管理

各サブエージェントは独自のコンテキストを持ちますが、`resume`（再開）を指示することで、以前の対話履歴を引き継いで作業を続けることができます。これにより、ゼロからコンテキストを再構築する手間が省けます。

## 7. サブエージェントの例

- **コードレビュアー:** コードを読み取り専用でレビューし、品質、セキュリティ、保守性に関するフィードバックを提供します。`tools`から`Edit`や`Write`を除外することで、安全性を確保します。
- **デバッガー:** エラーの診断から修正までを行うエージェント。`Edit`ツールへのアクセスを許可し、明確なデバッグプロセスをプロンプトで指示します。
- **データサイエンティスト:** SQLクエリやBigQueryの操作に特化したエージェント。より高性能な`sonnet`モデルを指定し、データ分析タスクに最適化します。
- **データベースクエリバリデーター:** `PreToolUse`フックを使用して、`Bash`コマンドの実行前に内容を検証し、書き込み操作（`INSERT`, `UPDATE`など）をブロックする読み取り専用のデータベースエージェント。

---

### 参考文献
[1] Anthropic. (n.d.). *Create custom subagents*. Claude Code Docs. Retrieved January 27, 2026, from https://code.claude.com/docs/en/sub-agents
